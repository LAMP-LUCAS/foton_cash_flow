<%#
  Arquivo: app/views/foton_cash_flow/entries/index.html.erb
  Descrição: View principal que renderiza a página de lançamentos do fluxo de caixa.
%>

<div class="cash-flow-page">
  <%# A validação principal: se as dependências não estiverem OK, renderiza apenas o modal de sincronização. %>
  <% unless @dependencies_met %>
    <%= render partial: 'sync_modal' %>
  <% else %>
    <%# Se as dependências estiverem OK, renderiza o cabeçalho da página. %>
    <div class="cf-header">
      <h2 class="cf-title"><%= l('foton_cash_flow.dashboard.title') %></h2>
      <div class="cf-header-actions">
        <%# Botões de ação para usuários com permissão de gerenciamento %>
        <% if User.current.allowed_to?(:manage_cash_flow_entries, @project, global: true) %>
          <%= link_to l('foton_cash_flow.general.import'), import_form_project_cash_flow_entries_path(@project), class: 'cf-btn cf-btn-secondary' %>
          <%# O link de exportação passa os filtros atuais para exportar exatamente o que o usuário vê %>
          <%= link_to l('foton_cash_flow.general.export_csv'), export_project_cash_flow_entries_path(@project, format: :csv, **@filter_params), class: 'cf-btn cf-btn-secondary' %>
          <%# link de sincronização das dependencias do plugin %>
          <%= render partial: 'sync_btn', locals: { button_class: 'cf-btn-secondary' } %>
        <% end %>
      </div>
    </div>

    <%# Após o cabeçalho, verifica se há lançamentos para exibir. %>
    <% if @issues_for_table.empty? %>
      <%# Se não houver dados, mostra uma mensagem informativa. %>
      <div class="nodata"><%= l('foton_cash_flow.notices.no_data') %></div>
    <% else %>
      <%# Se houver dados, renderiza o conteúdo principal da página. %>
      <div class="cf-main-content">
        <%# Conteúdo Primário (Tabela) %>
        <div class="cf-primary-content">
          <div class="cf-table-container">
            <%# Adiciona o sumário de contagem de lançamentos acima da tabela %>
            <div class="cf-table-summary">
              <span><%= l('foton_cash_flow.notices.table_summary', filtered: @issue_count, total: @total_project_entries_count) %></span>
            </div>
            <div id="cf-active-filters-bar"></div>
            <div class="cf-table-wrapper">
              <%= render partial: 'table', locals: {
                    project: @project,
                    issues_for_table: @issues_for_table,
                    issue_count: @issue_count,
                    issue_pages: @issue_pages,
                    limit: @limit
                } %>
            </div>
            <%# Adiciona os controles de paginação abaixo da tabela %>
            <div class="cf-pagination-controls">
              <span class="pagination">
                <%= pagination_links_full @issue_pages, @issue_count %>
              </span>            
            </div>
          </div>
        </div>
        <%# Seção de Sumário (Sidebar) %>
        <div class="cf-summary-section">
          <%= render partial: 'summary', locals: {
              total_revenue: @total_revenue,
              total_expense: @total_expense,
              balance: @balance
          } %>
        </div>
      </div>

      <div class="cf-secundary-content">
        <section>
          <%= render partial: 'charts', locals: {
            bar_chart_labels: @bar_chart_labels, bar_chart_revenue: @bar_chart_revenue, bar_chart_expense: @bar_chart_expense,
            pie_chart_labels: @pie_chart_labels, pie_chart_data: @pie_chart_data,
            balance_chart_labels: @balance_chart_labels, balance_chart_data: @balance_chart_data,
            cumulative_revenue_labels: @cumulative_revenue_labels, cumulative_revenue_data: @cumulative_revenue_data, cumulative_expense_data: @cumulative_expense_data
          } %>
        </section>
      </div>
    <% end %>

    <%# Renderiza os templates e assets de JS, que são necessários em ambos os casos (com ou sem dados). %>
    <%= render 'filter_templates' %>
    <%= render 'foton_cash_flow/shared/cash_flow_assets' %>

  <% end %>
</div>
