<%#
  Arquivo: app/views/foton_cash_flow/entries/index.html.erb
  Descrição: View principal que renderiza a página de lançamentos do fluxo de caixa.
%>

<div class="cash-flow-page">
  <div class="cf-header">
    <h2 class="cf-title"><%= l('foton_cash_flow.dashboard.title') %></h2>
    <div class="cf-header-actions">
      <%# Botões de ação para usuários com permissão de gerenciamento %>
      <% if User.current.allowed_to?(:manage_cash_flow_entries, @project, global: true) %>
        <%= link_to l('foton_cash_flow.general.import'), import_form_project_cash_flow_entries_path(@project), class: 'cf-btn cf-btn-primary' %>
        <%# O link de exportação passa os filtros atuais para exportar exatamente o que o usuário vê %>
        <%= link_to l('foton_cash_flow.general.export_csv'), export_project_cash_flow_entries_path(@project, format: :csv, **@filter_params), class: 'cf-btn cf-btn-secondary' %>
      <% end %>
      <%# O botão de sincronização é renderizado pela sua própria partial %>
      <%= render partial: 'sync_btn' %>
    </div>
  </div>

  <%# Se as dependências não forem atendidas, mostra o modal de sincronização e para. %>
  <% if !@dependencies_met %>
    <%= render partial: 'sync_modal' %>
  <%# Se as dependências estiverem OK, mas não houver dados, mostra a mensagem. %>
  <% elsif @issues_for_table.empty? %>
    <div class="nodata"><%= l('foton_cash_flow.notices.no_data') %></div>
  <%# Se tudo estiver OK e houver dados, renderiza a página completa. %>
  <% else %>
    <div class="cf-main-content">
      <%# Conteúdo Principal (Tabela e Sumário) %>
      <div class="cf-primary-content">

          <%# 1. Seção da Tabela de Lançamentos %>
          <div class="cf-table-container">
                <div id="cf-active-filters-bar"></div>
                <div class="cf-table-wrapper">
                  <%= render partial: 'table', locals: {
                        project: @project,
                        issues_for_table: @issues_for_table,
                        issue_count: @issue_count,
                        issue_pages: @issue_pages,
                        limit: @limit
                    } %>
                </div>
              </div>


          </div>

          <%# 3. Seção de Sumário (Sidebar) %>
          <div class="cf-summary-section">
            <%= render partial: 'summary', locals: {
                total_revenue: @total_revenue,
                total_expense: @total_expense,
                balance: @balance
            } %>
          </div>
      </div>

      <div class="cf-secundary-content">
        <%# 2. Seção de Gráficos (movida para dentro do conteúdo primário) %>
        <section>
          <%= render partial: 'charts', locals: {
            bar_chart_labels: @bar_chart_labels, bar_chart_revenue: @bar_chart_revenue, bar_chart_expense: @bar_chart_expense,
            pie_chart_labels: @pie_chart_labels, pie_chart_data: @pie_chart_data,
            balance_chart_labels: @balance_chart_labels, balance_chart_data: @balance_chart_data,
            cumulative_revenue_labels: @cumulative_revenue_labels, cumulative_revenue_data: @cumulative_revenue_data, cumulative_expense_data: @cumulative_expense_data
          } %>
        </section>
      </div>

    <%# 4. Renderiza os templates ocultos que serão usados pelo JavaScript (ex: modal de filtros) %>
    <%= render 'filter_templates' %>
    <%# 5. Renderiza a parcial que carrega todos os scripts JS necessários para esta página. %>
    <%= render 'foton_cash_flow/shared/cash_flow_assets' %>
  <% end %>
</div>
